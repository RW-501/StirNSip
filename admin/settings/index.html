<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Settings | Stir & Sip Admin</title>
  <!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <link rel="stylesheet" href="../settings/style.css">

</head>
<body>
  <!-- NAVIGATION -->
  <nav class="navbar">
    <div class="nav-brand"><a href="./index.html" class="home">Stir & Sip Admin</a></div>
    <ul class="nav-links">
      <li><a href="../index.html">Dashboard</a></li>
      <li><a href="#" class="active">Settings</a></li>
      <li><a href="logout.html">Logout</a></li>
    </ul>
  </nav>

  <main>

<!-- Login screen (hidden by default) -->
<section id="login-screen" style="display:none; max-width:400px; margin:2rem auto;">
  <h2>Admin Login</h2>

  <button id="googleLoginBtn">Login with Google</button>
  <button id="phoneLoginBtn">Login with Phone</button>

  <div id="phoneLoginForm" style="display:none; margin-top:1rem;">
    <input type="tel" id="phoneNumber" placeholder="+1 555-555-5555" />
    <button id="sendCodeBtn">Send Code</button>
    <input type="text" id="verificationCode" placeholder="Enter code" style="display:none; margin-top:0.5rem;" />
    <button id="verifyCodeBtn" style="display:none; margin-top:0.5rem;">Verify Code</button>
  </div>

  <p id="loginError" style="color:red;"></p>
</section>


<section id="site-settings" style="display:none;">
          <h1>Site Settings</h1>

      <!-- Hero Image -->
      <label for="heroImage">Hero Image:</label>
      <input type="file" id="heroImage" accept="image/*" />
      <img id="heroPreview" src="" alt="Hero Preview" style="max-width:300px; display:block; margin:0.5rem 0;" />

<label for="aboutEditor">About Section:</label>
<div id="aboutEditor" style="height: 200px;"></div>

<!-- Main Merch Image -->
<label for="mainMerchImage">Main Merch Image:</label>
<input type="file" id="mainMerchImage" accept="image/*" />
<img id="mainMerchPreview" src="" alt="Main Merch Preview" style="max-width:300px; display:block; margin:0.5rem 0;" />
<label>
  <input type="checkbox" id="showMerchOnHome" />
  Show on Home
</label>


<!-- FAQ -->
<label>FAQs:</label>
<div id="faqContainer"></div>
<button type="button" id="addFaqBtn">+ Add FAQ</button>


      <!-- Contact Info -->
      <label for="contactInfo">Contact Info (Email / Phone):</label>
      <textarea id="contactInfo" placeholder="Enter contact details..." rows="2"></textarea>

      <button id="saveSettings">Save Settings</button>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <p>&copy; <span id="year"></span> Stir & Sip. Admin Panel.</p>
  </footer>

  <!-- Firebase -->
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, Timestamp  } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithPhoneNumber, RecaptchaVerifier, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

import { showToast } from 'https://rw-501.github.io/StirNSip/js/showToast.js';

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBlN_vkUzQMfsCSFttdKA2ZMNz8v26JrQ8",
  authDomain: "stirnsip-978dc.firebaseapp.com",
  projectId: "stirnsip-978dc",
  storageBucket: "stirnsip-978dc.firebasestorage.app",
  messagingSenderId: "727033774529",
  appId: "1:727033774529:web:b2d103f6231bec75916f40",
  measurementId: "G-E72374YTPE",
};

// Init Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// DOM
const heroImageInput = document.getElementById("heroImage");
const heroPreview = document.getElementById("heroPreview");
const aboutText = document.getElementById("aboutText");
const contactInfo = document.getElementById("contactInfo");
const saveSettingsBtn = document.getElementById("saveSettings");
const faqContainer = document.getElementById("faqContainer");
const addFaqBtn = document.getElementById("addFaqBtn");

// Initialize Quill
const aboutEditor = new Quill("#aboutEditor", {
  theme: "snow",  // 'bubble' is another option
  placeholder: "Write about your brand...",
  modules: {
    toolbar: [
      ["bold", "italic", "underline", "strike"],
      ["blockquote", "code-block"],
      [{ header: 1 }, { header: 2 }],
      [{ list: "ordered" }, { list: "bullet" }],
      [{ script: "sub" }, { script: "super" }],
      [{ indent: "-1" }, { indent: "+1" }],
      [{ color: [] }, { background: [] }],
      [{ align: [] }],
      ["link", "image", "video"],
      ["clean"]
    ]
  }
});

const auth = getAuth();
const loginScreen = document.getElementById("login-screen");
const siteSettings = document.getElementById("site-settings");
const loginError = document.getElementById("loginError");

const googleLoginBtn = document.getElementById("googleLoginBtn");
const phoneLoginBtn = document.getElementById("phoneLoginBtn");
const phoneLoginForm = document.getElementById("phoneLoginForm");
const phoneNumberInput = document.getElementById("phoneNumber");
const sendCodeBtn = document.getElementById("sendCodeBtn");
const verificationCodeInput = document.getElementById("verificationCode");
const verifyCodeBtn = document.getElementById("verifyCodeBtn");

// Allowed emails and phone numbers
const allowedEmails = ["1988lrp@gmail.com", "owner@stirnsip.com"];
const allowedPhones = ["+19725977878", "+14445556666"];


// Show/hide sections based on login state
onAuthStateChanged(auth, (user) => {
  if (user) {
    // Check allowed emails/phones
    const emailOk = user.email && allowedEmails.includes(user.email);
    const phoneOk = user.phoneNumber && allowedPhones.includes(user.phoneNumber);

    if (emailOk || phoneOk) {
      loginScreen.style.display = "none";
      siteSettings.style.display = "block";
      loadSettings(); // your existing function
    } else {
      auth.signOut();
      loginError.textContent = "Unauthorized user.";
    }
  } else {
    loginScreen.style.display = "block";
    siteSettings.style.display = "none";
  }
});

// Google login
googleLoginBtn.addEventListener("click", async () => {
  const provider = new GoogleAuthProvider();
  try {
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    if (!allowedEmails.includes(user.email)) {
      await auth.signOut();
      loginError.textContent = "Unauthorized Google account.";
    } else {
      loginError.textContent = "";
    }
  } catch(err) {
    console.error(err);
    loginError.textContent = "Google login failed.";
  }
});

// Phone login
phoneLoginBtn.addEventListener("click", () => {
  phoneLoginForm.style.display = "block";
  window.recaptchaVerifier = new RecaptchaVerifier('sendCodeBtn', {
    'size': 'invisible',
    'callback': () => {}
  }, auth);
});

sendCodeBtn.addEventListener("click", async () => {
  const phoneNumber = phoneNumberInput.value;
  if (!allowedPhones.includes(phoneNumber)) {
    loginError.textContent = "Unauthorized phone number.";
    return;
  }
  const appVerifier = window.recaptchaVerifier;
  try {
    const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
    window.confirmationResult = confirmationResult;
    verificationCodeInput.style.display = "block";
    verifyCodeBtn.style.display = "block";
    loginError.textContent = "";
  } catch(err) {
    console.error(err);
    loginError.textContent = "Failed to send code.";
  }
});

verifyCodeBtn.addEventListener("click", async () => {
  const code = verificationCodeInput.value;
  try {
    await window.confirmationResult.confirm(code);
    loginError.textContent = "";
  } catch(err) {
    console.error(err);
    loginError.textContent = "Invalid verification code.";
  }
});

// Add FAQ row
function addFaqItem(question = "", answer = "") {
  const div = document.createElement("div");
  div.classList.add("faq-item");
  div.innerHTML = `
    <input type="text" placeholder="Question" value="${question}" required />
    <textarea placeholder="Answer" rows="2" required>${answer}</textarea>
    <button type="button" class="removeFaqBtn">Remove</button>
  `;
  faqContainer.appendChild(div);

  div.querySelector(".removeFaqBtn").addEventListener("click", () => div.remove());
}

// Add FAQ button
addFaqBtn.addEventListener("click", () => addFaqItem());

// Load settings
async function loadSettings() {
  try {
    const settingsDoc = doc(db, "siteSettings", "main");
    const docSnap = await getDoc(settingsDoc);
    if (docSnap.exists()) {
      const data = docSnap.data();
      heroPreview.src = data.heroImage || "";
      aboutEditor.root.innerHTML = data.about || "";

      contactInfo.value = data.contact || "";
      
mainMerchPreview.src = data.mainMerchImage || "";
showMerchOnHome.checked = data.showMerchOnHome || false;

      // Load FAQs dynamically
      faqContainer.innerHTML = "";
      const faqs = data.faq || [];
      faqs.forEach(f => addFaqItem(f.question, f.answer));
    }
  } catch(err) {
    console.error("Error loading settings:", err);
  }
}

// Upload hero image
async function uploadHeroImage(file) {
  const fileName = `hero_${Date.now()}_${file.name}`;
  const storageRef = ref(storage, `settings/${fileName}`);
  await uploadBytes(storageRef, file);
  return await getDownloadURL(storageRef);
}

// Save settings
saveSettingsBtn.addEventListener("click", async () => {
  try {
    let heroUrl = heroPreview.src;
    if (heroImageInput.files[0]) {
      heroUrl = await uploadHeroImage(heroImageInput.files[0]);
      heroPreview.src = heroUrl;
    }

    // Gather FAQ data
    const faqs = Array.from(faqContainer.querySelectorAll(".faq-item")).map(item => ({
      question: item.querySelector("input").value,
      answer: item.querySelector("textarea").value
    }));

    const aboutHtml = aboutEditor.root.innerHTML; // Quill stores rich text as HTML

// Inside saveSettingsBtn click listener
let mainMerchUrl = mainMerchPreview.src;
if (mainMerchImageInput.files[0]) {
  mainMerchUrl = await uploadMainMerchImage(mainMerchImageInput.files[0]);
  mainMerchPreview.src = mainMerchUrl;
}

// Add to settingsData
const settingsData = {
  heroImage: heroUrl,
  mainMerchImage: mainMerchUrl,
  showMerchOnHome: showMerchOnHome.checked,
  about: aboutHtml,
  faq: faqs,
  contact: contactInfo.value,
  updatedAt: Timestamp.fromDate(new Date())
};


    const settingsDoc = doc(db, "siteSettings", "main");
    await updateDoc(settingsDoc, settingsData).catch(async () => {
      await setDoc(settingsDoc, settingsData);
    });
    alert("Settings saved!");
  } catch(err) {
    console.error("Error saving settings:", err);
  }
});

const mainMerchImageInput = document.getElementById("mainMerchImage");
const mainMerchPreview = document.getElementById("mainMerchPreview");
const showMerchOnHome = document.getElementById("showMerchOnHome");

// Preview selected merch image
mainMerchImageInput.addEventListener("change", () => {
  const file = mainMerchImageInput.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => mainMerchPreview.src = e.target.result;
    reader.readAsDataURL(file);
  }
});

// Upload function (like hero image)
async function uploadMainMerchImage(file) {
  const fileName = `merch_main_${Date.now()}_${file.name}`;
  const storageRef = ref(storage, `settings/${fileName}`);
  await uploadBytes(storageRef, file);
  return await getDownloadURL(storageRef);
}


// Initial load
loadSettings();

// Auto-update year
document.getElementById("year").textContent = new Date().getFullYear();
</script>

</body>
</html>
